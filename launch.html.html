<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>勞工體格健康管理分析系統</title>
  <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: 'Microsoft JhengHei', Arial, sans-serif; background: #f5f7fa; margin: 0; padding: 20px; }
    .container { max-width: 1200px; margin: auto; }
    h1 { text-align: center; color: #2c3e50; margin-bottom: 10px; }
    .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; }
    .charts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 40px; }
    .chart-card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .chart-card h3 { text-align: center; color: #34495e; margin-top: 0; }
    canvas { max-height: 300px; width: 100%; }
    .summary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; text-align: center; margin-bottom: 30px; }
    .summary h2 { margin: 0; font-size: 2em; }
    
    /* 表格樣式 */
    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    th, td { padding: 12px; text-align: center; border-bottom: 1px solid #eee; white-space: nowrap; }
    th { background: #3498db; color: white; }
    tr:hover { background: #f1f8ff; }
    
    /* 風險標籤 */
    .tag { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; display: inline-block; margin: 2px; }
    .risk-high { background: #ffebee; color: #c62828; border: 1px solid #ffcdd2; }
    .risk-med { background: #fff3e0; color: #ef6c00; border: 1px solid #ffe0b2; }
    .risk-ok { background: #e8f5e8; color: #2e7d32; border: 1px solid #c8e6c9; }
    
    footer { text-align: center; margin-top: 50px; color: #95a5a6; font-size: 0.9em; }
    .loading { text-align: center; font-size: 1.2em; color: #666; margin: 50px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>勞工體格健康管理分析系統</h1>
    <p class="subtitle">基於國健署標準 • 10 位勞工體檢資料分析（2025-12-28）</p>

    <div class="summary">
      <h2 id="totalRisk">資料載入中...</h2>
      <p id="riskDesc">正在分析健康數據</p>
    </div>

    <div class="charts-grid">
      <div class="chart-card">
        <h3>BMI 體位分佈</h3>
        <canvas id="bmiChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>血壓分級 (JNC7/TW)</h3>
        <canvas id="bpChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>三高異常盛行率</h3>
        <canvas id="threeHighChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>代謝症候群 (危險因子數)</h3>
        <canvas id="metsChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>腎功能 (eGFR) 分期</h3>
        <canvas id="egfrChart"></canvas>
      </div>
    </div>

    <h2 style="color: #2c3e50;">異常名單與個人風險明細</h2>
    <div class="table-container">
      <table id="riskTable">
        <thead>
          <tr>
            <th>姓名</th>
            <th>性別/年齡</th>
            <th>BMI</th>
            <th>血壓 (mmHg)</th>
            <th>空腹血糖</th>
            <th>血脂 (TG/HDL)</th>
            <th>腰圍</th>
            <th>代謝症候群</th>
            <th>綜合風險</th>
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>
    </div>
  </div>

  <footer>THAS FHIR Sandbox Demo Version 1.0</footer>

  <script>
    // 1. 初始化入口
    window.onload = async function() {
      // 驗證state防CSRF
      const urlParams = new URLSearchParams(window.location.search);
      const returnedState = urlParams.get('state');
      if (returnedState !== sessionStorage.getItem('oauthState')) {
        alert('State mismatch: Potential CSRF attack!');
        return;
      }

      const isMockMode = urlParams.get('mode') === 'mock';

      let patientsData = [];

      if (isMockMode) {
        console.log("進入快速測試模式：使用模擬資料");
        patientsData = generateMockData();
        renderDashboard(patientsData);
      } else {
        // FHIR Launch 流程
        FHIR.oauth2.ready()
          .then(async function(client) {
            console.log("FHIR Client Ready", client);
            document.getElementById('riskDesc').innerText = "FHIR 連線成功，載入資料中...";
            patientsData = await fetchFHIRData(client);  // 動態擷取
            renderDashboard(patientsData);
          })
          .catch(function(e) {
            console.error(e);
            // Fallback to mock
            patientsData = generateMockData();
            renderDashboard(patientsData);
          });
      }
    };

    // 2. 模擬資料生成 (隨機但偏向有風險案例)
    function generateMockData() {
      const names = ['陳大明', '李小華', '王志強', '張美玲', '劉建國', '黃淑芬', '林志豪', '吳怡君', '鄭國泰', '蔡明芳'];
      const genders = ['M', 'F', 'M', 'F', 'M', 'F', 'M', 'F', 'M', 'F'];
      return names.map((name, i) => {
        const gender = genders[i];
        const age = 30 + Math.floor(Math.random() * 25);
        const height = 160 + Math.floor(Math.random() * 20);
        const weight = 60 + Math.floor(Math.random() * 30);
        const sbp = 110 + Math.floor(Math.random() * 50);
        const dbp = 70 + Math.floor(Math.random() * 30);
        const glu = 80 + Math.floor(Math.random() * 50);
        const tg = 100 + Math.floor(Math.random() * 150);
        const hdl = 40 + Math.floor(Math.random() * 30);
        const waist = (gender === 'M' ? 85 : 75) + Math.floor(Math.random() * 20);
        const creat = 0.7 + Math.random() * 0.6;
        return { name, gender, age, height, weight, sbp, dbp, glu, tg, hdl, waist, creat };
      });
    }

    // 3. 單一勞工分析 (國健署標準)
    function analyzePatient(p) {
      p.bmi = (p.weight / ((p.height / 100) ** 2)).toFixed(1);
      p.bmiTag = p.bmi < 24 ? '正常' : (p.bmi < 27 ? '過重' : '肥胖');
      p.bmiClass = p.bmi < 24 ? 'risk-ok' : (p.bmi < 27 ? 'risk-med' : 'risk-high');

      p.bpTag = (p.sbp < 120 && p.dbp < 80) ? '正常' : ((p.sbp < 140 && p.dbp < 90) ? '前期' : '高血壓');
      p.bpClass = p.bpTag === '正常' ? 'risk-ok' : (p.bpTag === '前期' ? 'risk-med' : 'risk-high');

      p.gluTag = p.glu < 100 ? '正常' : (p.glu < 126 ? '高血糖前期' : '糖尿病');
      p.gluClass = p.glu < 100 ? 'risk-ok' : (p.glu < 126 ? 'risk-med' : 'risk-high');

      p.lipidTag = (p.tg >= 150 || (p.gender === 'M' ? p.hdl < 40 : p.hdl < 50)) ? '異常' : '正常';
      p.lipidClass = p.lipidTag === '正常' ? 'risk-ok' : 'risk-high';

      p.waistTag = (p.gender === 'M' ? p.waist >= 90 : p.waist >= 80) ? '異常' : '正常';
      p.waistClass = p.waistTag === '正常' ? 'risk-ok' : 'risk-high';

      p.metsCount = 0;
      if (p.gender === 'M' ? p.waist >= 90 : p.waist >= 80) p.metsCount++;
      if (p.tg >= 150) p.metsCount++;
      if (p.gender === 'M' ? p.hdl < 40 : p.hdl < 50) p.metsCount++;
      if (p.sbp >= 130 || p.dbp >= 85) p.metsCount++;
      if (p.glu >= 100) p.metsCount++;
      p.metsTag = p.metsCount >= 3 ? `${p.metsCount}項 (確診)` : `${p.metsCount}項`;
      p.metsClass = p.metsCount < 2 ? 'risk-ok' : (p.metsCount < 3 ? 'risk-med' : 'risk-high');

      p.egfr = (186 * (p.creat ** -1.154) * (p.age ** -0.203) * (p.gender === 'F' ? 0.742 : 1)).toFixed(1);
      p.egfrTag = p.egfr >= 90 ? 'G1 正常' : (p.egfr >= 60 ? 'G2 輕度' : (p.egfr >= 30 ? 'G3 中度' : 'G4/G5 重度'));
      p.egfrClass = p.egfr >= 90 ? 'risk-ok' : (p.egfr >= 60 ? 'risk-med' : 'risk-high');

      p.overallRisk = [p.bmiClass, p.bpClass, p.gluClass, p.lipidClass, p.waistClass, p.metsClass, p.egfrClass]
        .reduce((acc, cls) => Math.max(acc, cls === 'risk-high' ? 3 : (cls === 'risk-med' ? 2 : 1)), 1);
      p.overallTag = p.overallRisk === 1 ? '低風險' : (p.overallRisk === 2 ? '中風險' : '高風險');
      p.overallClass = p.overallRisk === 1 ? 'risk-ok' : (p.overallRisk === 2 ? 'risk-med' : 'risk-high');

      return p;
    }

    // 4. 儀表板渲染
    function renderDashboard(rawData) {
      const analyzedData = rawData.map(analyzePatient);

      // 摘要計算
      const highRisk = analyzedData.filter(d => d.overallRisk === 3).length;
      const medRisk = analyzedData.filter(d => d.overallRisk === 2).length;
      const lowRisk = analyzedData.length - highRisk - medRisk;
      document.getElementById('totalRisk').innerText = `高風險 ${highRisk} 人 | 中風險 ${medRisk} 人 | 低風險 ${lowRisk} 人`;
      document.getElementById('riskDesc').innerText = `總計 ${analyzedData.length} 位勞工`;

      // 表格填充
      const tbody = document.querySelector('#riskTable tbody');
      tbody.innerHTML = '';
      analyzedData.forEach(p => {
        const row = `
          <tr>
            <td>${p.name}</td>
            <td>${p.gender}/${p.age}</td>
            <td><span class="tag ${p.bmiClass}">${p.bmi} (${p.bmiTag})</span></td>
            <td><span class="tag ${p.bpClass}">${p.sbp}/${p.dbp} (${p.bpTag})</span></td>
            <td><span class="tag ${p.gluClass}">${p.glu} (${p.gluTag})</span></td>
            <td><span class="tag ${p.lipidClass}">${p.tg}/${p.hdl} (${p.lipidTag})</span></td>
            <td><span class="tag ${p.waistClass}">${p.waist} (${p.waistTag})</span></td>
            <td><span class="tag ${p.metsClass}">${p.metsTag}</span></td>
            <td><span class="tag ${p.overallClass}">${p.overallTag}</span></td>
          </tr>
        `;
        tbody.innerHTML += row;
      });

      // 繪製圖表
      drawCharts(analyzedData);
    }

    // 5. Chart.js 設定
    function drawCharts(data) {
      // BMI Chart
      new Chart(document.getElementById('bmiChart'), {
        type: 'doughnut',
        data: {
          labels: ['正常', '過重', '肥胖'],
          datasets: [{
            data: [
              data.filter(d => d.bmi < 24).length,
              data.filter(d => d.bmi >= 24 && d.bmi < 27).length,
              data.filter(d => d.bmi >= 27).length
            ],
            backgroundColor: ['#4bc0c0', '#ffcd56', '#ff6384']
          }]
        }
      });

      // BP Chart
      new Chart(document.getElementById('bpChart'), {
        type: 'bar',
        data: {
          labels: ['正常', '高血壓前期', '高血壓'],
          datasets: [{
            label: '人數',
            data: [
              data.filter(d => d.sbp < 120 && d.dbp < 80).length,
              data.filter(d => (d.sbp >= 120 && d.sbp < 140) || (d.dbp >= 80 && d.dbp < 90)).length,
              data.filter(d => d.sbp >= 140 || d.dbp >= 90).length
            ],
            backgroundColor: ['#4bc0c0', '#ff9f40', '#ff6384']
          }]
        }
      });

      // Three Highs (三高)
      new Chart(document.getElementById('threeHighChart'), {
        type: 'bar',
        data: {
          labels: ['高血壓', '高血糖', '高血脂(TG高或HDL低)'],
          datasets: [{
            label: '異常人數',
            data: [
              data.filter(d => d.sbp >= 130 || d.dbp >= 85).length,
              data.filter(d => d.glu >= 100).length,
              data.filter(d => d.tg >= 150 || (d.gender==='M' && d.hdl<40) || (d.gender==='F' && d.hdl<50)).length
            ],
            backgroundColor: '#36a2eb'
          }]
        }
      });

      // MetS Chart
      const metsCounts = [0, 0, 0, 0, 0, 0];
      data.forEach(d => metsCounts[d.metsCount]++);
      new Chart(document.getElementById('metsChart'), {
        type: 'line',
        data: {
          labels: ['0項', '1項', '2項', '3項 (確診)', '4項', '5項'],
          datasets: [{
            label: '人數分佈',
            data: metsCounts,
            fill: true,
            borderColor: '#9966ff',
            backgroundColor: 'rgba(153, 102, 255, 0.2)'
          }]
        }
      });

      // eGFR Chart
      new Chart(document.getElementById('egfrChart'), {
        type: 'pie',
        data: {
          labels: ['G1 (正常)', 'G2 (輕度衰退)', 'G3 (中度)', 'G4/G5 (重度)'],
          datasets: [{
            data: [
              data.filter(d => d.egfr >= 90).length,
              data.filter(d => d.egfr >= 60 && d.egfr < 90).length,
              data.filter(d => d.egfr >= 30 && d.egfr < 60).length,
              data.filter(d => d.egfr < 30).length
            ],
            backgroundColor: ['#4bc0c0', '#ffcd56', '#ff9f40', '#ff6384']
          }]
        }
      });
    }
  </script>
</body>
</html>